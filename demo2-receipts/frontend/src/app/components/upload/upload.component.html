<div class="upload-container">
  <!-- Approach Selector -->
  <div class="approach-selector">
    <button
      [class.active]="approach === 'simple'"
      [class.has-results]="results.simple !== null"
      (click)="switchApproach('simple')"
      class="approach-btn simple-btn"
    >
      <span class="btn-title">‚ö° Simple (Single Call)</span>
      <span class="btn-description">Multimodal Claude using prompt + image with Zod schema validation</span>
      @if (results.simple) {
        <span class="cached-indicator">‚úì</span>
      }
    </button>
    <button
      [class.active]="approach === 'chain'"
      [class.has-results]="results.chain !== null"
      (click)="switchApproach('chain')"
      class="approach-btn chain-btn"
    >
      <span class="btn-title">üîó Chain (Orchestrated)</span>
      <span class="btn-description">LangChain multi-step workflow with vision and structured output</span>
      @if (results.chain) {
        <span class="cached-indicator">‚úì</span>
      }
    </button>
    <button
      [class.active]="approach === 'tool-calling'"
      [class.has-results]="results['tool-calling'] !== null"
      (click)="switchApproach('tool-calling')"
      class="approach-btn tool-btn"
    >
      <span class="btn-title">üõ†Ô∏è Tool Calling (AI Reasoning)</span>
      <span class="btn-description">Claude using tools for semantic search, date filtering, and budget matching with SSE streaming</span>
      @if (results['tool-calling']) {
        <span class="cached-indicator">‚úì</span>
      }
    </button>
  </div>

  <!-- Approach Info Section (shows under selected button) -->
  <div class="approach-info-section">
    <div class="info-card">
      <div class="info-problem">
        <h4>üí° Problem We're Solving</h4>
        <p>{{ getApproachInfo(approach).problem }}</p>
      </div>
      <div class="info-tech">
        <h4>üõ†Ô∏è Tech Stack</h4>
        <ul>
          @for (tech of getApproachInfo(approach).tech; track tech) {
            <li>{{ tech }}</li>
          }
        </ul>
      </div>
    </div>
  </div>

  <!-- Upload Area -->
  @if (!imagePreview) {
    <div
      class="upload-area"
      (drop)="onFileDrop($event)"
      (dragover)="onDragOver($event)"
    >
      <div class="upload-icon">üì§</div>
      <p class="upload-text">Drag & drop receipt image here</p>
      <p class="upload-subtext">or</p>
      <label for="file-input" class="file-select-btn">
        Choose File
      </label>
      <input
        id="file-input"
        type="file"
        accept="image/*,application/pdf"
        (change)="onFileSelected($event)"
        style="display: none"
      />
      <p class="upload-hint">Supports: JPG, PNG, GIF, WebP, PDF</p>
    </div>
  }

  <!-- Image/PDF Preview & Parse -->
  @if (imagePreview && !result) {
    <div class="preview-section">
      <div class="preview-header">
        <h3>{{ isPdf ? 'Receipt PDF' : 'Receipt Image' }}</h3>
        <div class="header-actions">
          <button
            (click)="parseReceipt()"
            [disabled]="loading || streaming || results[approach] !== null"
            class="parse-btn"
          >
            @if (loading) {
              <span class="spinner"></span> Parsing...
            } @else if (streaming) {
              <span class="spinner"></span> Analyzing...
            } @else if (results[approach]) {
              ‚úì Results Ready
            } @else {
              üîç Parse Receipt
            }
          </button>
          <button (click)="reset()" class="reset-btn">‚úï Remove</button>
        </div>
      </div>
      @if (isPdf) {
        <div class="pdf-preview">
          <div class="pdf-icon">üìÑ</div>
          <p class="pdf-name">{{ selectedFile?.name }}</p>
          <iframe [src]="safePdfUrl" class="pdf-embed" title="PDF preview"></iframe>
        </div>
      } @else {
        <div class="image-preview-container">
          <img
            [src]="imagePreview"
            alt="Receipt preview"
            class="receipt-preview"
            (click)="toggleImageEnlarged()"
            title="Click to enlarge"
          />
          <div class="enlarge-hint">üîç Click to enlarge</div>
        </div>
      }
    </div>
  }

  <!-- Results -->
  @if (result) {
    <div class="results-section">
      <div class="results-header">
        <h3>Parsing Results</h3>
        <button (click)="reset()" class="reset-btn">üîÑ Parse Another</button>
      </div>

      <!-- Status Badge -->
      @if (result.status) {
        <div class="status-badge" [ngClass]="getStatusClass(result.status)">
          @if (result.status === 'success') {
            ‚úÖ Successfully Parsed
          } @else if (result.status === 'partial') {
            ‚ö†Ô∏è Partially Parsed
          } @else if (result.status === 'not_a_receipt') {
            ‚ùå Not a Receipt
          } @else {
            ‚ùå Unreadable
          }
        </div>
      }

      <!-- Success/Partial Results -->
      @if (result.status === 'success' || result.status === 'partial') {
        <div class="receipt-card">
          <div class="receipt-header">
            <h2>{{ result.receipt?.merchant }}</h2>
            @if (result.receipt?.confidence) {
              <span class="confidence-badge" [ngClass]="getConfidenceClass(result.receipt!.confidence)">
                {{ result.receipt!.confidence }} confidence
              </span>
            }
          </div>

          <div class="receipt-details">
            <div class="detail-row">
              <span class="label">Date:</span>
              <span class="value">{{ result.receipt?.date }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Category:</span>
              <span class="value category-badge">{{ result.receipt?.category }}</span>
            </div>
            @if (result.receipt?.subtotal) {
              <div class="detail-row">
                <span class="label">Subtotal:</span>
                <span class="value">${{ result.receipt!.subtotal!.toFixed(2) }}</span>
              </div>
            }
            <div class="detail-row">
              <span class="label">Tax:</span>
              <span class="value">${{ result.receipt!.tax.toFixed(2) }}</span>
            </div>
            @if (result.receipt?.taxPercentage) {
              <div class="detail-row highlight">
                <span class="label">Tax %:</span>
                <span class="value">{{ result.receipt!.taxPercentage!.toFixed(2) }}%</span>
              </div>
            }
            <div class="detail-row total">
              <span class="label">Total:</span>
              <span class="value">${{ result.receipt!.total.toFixed(2) }}</span>
            </div>
          </div>

          @if (result.receipt?.items && result.receipt!.items!.length > 0) {
            <div class="items-section">
              <h4>Items:</h4>
              <div class="items-list">
                @for (item of result.receipt!.items!; track item.description) {
                  <div class="item-row">
                    <span class="item-desc">{{ item.description }}</span>
                    @if (item.quantity) {
                      <span class="item-qty">√ó{{ item.quantity }}</span>
                    }
                    <span class="item-price">${{ item.price.toFixed(2) }}</span>
                  </div>
                }
              </div>
            </div>
          }

          @if (result.notes) {
            <div class="notes">
              <strong>Note:</strong> {{ result.notes }}
            </div>
          }
        </div>

        <!-- Partial Warning -->
        @if (result.status === 'partial') {
          <div class="warning-box">
            <h4>‚ö†Ô∏è Partial Parse</h4>
            <p>{{ result.message }}</p>
            @if (result.missingFields && result.missingFields.length > 0) {
              <p><strong>Missing fields:</strong> {{ result.missingFields.join(', ') }}</p>
            }
            @if (result.suggestions && result.suggestions.length > 0) {
              <div class="suggestions">
                <strong>Suggestions:</strong>
                <ul>
                  @for (suggestion of result.suggestions; track suggestion) {
                    <li>{{ suggestion }}</li>
                  }
                </ul>
              </div>
            }
          </div>
        }
      }

      <!-- Error Results -->
      @if (result.status === 'not_a_receipt' || result.status === 'unreadable') {
        <div class="error-box">
          <h4>
            @if (result.status === 'not_a_receipt') {
              Not a Receipt
            } @else {
              Image Unreadable
            }
          </h4>
          <p>{{ result.reason }}</p>
          @if (result.suggestions && result.suggestions.length > 0) {
            <div class="suggestions">
              <strong>Try this:</strong>
              <ul>
                @for (suggestion of result.suggestions; track suggestion) {
                  <li>{{ suggestion }}</li>
                }
              </ul>
            </div>
          }
        </div>
      }

      <!-- Matched Task (Tool Calling Only) -->
      @if (result.matching) {
        <div class="matched-task-section">
          <h3>üéØ Matched Task</h3>

          @if (result.matching.match) {
            <div class="match-card">
              <div class="match-header">
                <h4>{{ result.matching.match.title }}</h4>
                <div class="confidence-badge" [class.high]="result.matching.match.confidenceScore >= 80"
                     [class.medium]="result.matching.match.confidenceScore >= 60 && result.matching.match.confidenceScore < 80"
                     [class.low]="result.matching.match.confidenceScore < 60">
                  {{ result.matching.match.confidenceScore }}% Confidence
                </div>
              </div>

              @if (result.matching.match.description) {
                <p class="match-description">{{ result.matching.match.description }}</p>
              }

              <div class="match-details">
                <div class="detail-row">
                  <span class="label">Task ID:</span>
                  <span class="value">{{ result.matching.match.taskId }}</span>
                </div>
                @if (result.matching.match.assignee) {
                  <div class="detail-row">
                    <span class="label">Assigned to:</span>
                    <span class="value">{{ result.matching.match.assignee }}</span>
                  </div>
                }
                <div class="detail-row">
                  <span class="label">Budget:</span>
                  <span class="value">${{ result.matching.match.budget.toFixed(2) }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Receipt Amount:</span>
                  <span class="value">${{ result.receipt!.total.toFixed(2) }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Task Period:</span>
                  <span class="value">{{ result.matching.match.createdAt | date:'mediumDate' }} - {{ result.matching.match.dueDate | date:'mediumDate' }}</span>
                </div>
              </div>

              <div class="match-reasons">
                 @if (result.matching.reasoning) {
                  <p> {{ result.matching.reasoning }}</p>
                }
                <h5 style="margin-top: 1rem;">Match Reasons:</h5>
                <ul>
                  @for (reason of result.matching.match.matchReasons; track reason) {
                    <li>{{ reason }}</li>
                  }
                </ul>
              </div>
            </div>
          } @else {
            <div class="no-match-card">
              <p>‚ùå No matching task found for this receipt.</p>
              <p class="hint">The receipt may not match any task budgets, dates, or categories.</p>
            </div>
          }
        </div>
      }

      <!-- Approach Info -->
      <div class="approach-info">
        <strong>Parsed using:</strong>
        @if (result.approach === 'simple') {
          Simple (Single Vision Call)
        } @else if (result.approach === 'chain') {
          Chain (LangChain Orchestration)
        } @else if (result.approach === 'tool-calling') {
          Tool Calling (AI Reasoning with Tools)
        }
      </div>
    </div>
  }


  <!-- SSE Streaming Progress (Tool Calling) -->
  @if (streaming || (progressMessages.length > 0 && approach === 'tool-calling')) {
    <div class="streaming-section">
      <div class="streaming-header">
        <h3>ü§ñ AI Reasoning Process</h3>
        @if (streaming) {
          <span class="live-badge">‚óè LIVE</span>
        }
      </div>

      <!-- Progress Messages -->
      @if (progressMessages.length > 0) {
        <div class="progress-log">
          <h4>Progress Log</h4>
          <div class="log-messages">
            @for (msg of progressMessages; track $index) {
              <div class="log-message">
                <span class="log-time">{{ msg.timestamp | date:'HH:mm:ss.SSS' }}</span>
                <span class="log-text">{{ msg.message }}</span>
              </div>
            }
          </div>
        </div>
      }

      <!-- Tool Calls -->
      @if (toolCalls.length > 0) {
        <div class="tool-calls-section">
          <h4>üîß Tools Called</h4>
          @for (call of toolCalls; track $index) {
            <div class="tool-call-card">
              <div class="tool-call-header">
                <strong>{{ call.name }}</strong>
                @if (call.result) {
                  <span class="tool-status complete">‚úì Complete</span>
                } @else {
                  <span class="tool-status running">‚è≥ Running...</span>
                }
              </div>
              <div class="tool-call-input">
                <strong>Input:</strong>
                <pre>{{ call.input | json }}</pre>
              </div>
              @if (call.result) {
                <div class="tool-call-result">
                  <strong>Result:</strong>
                  <pre>{{ call.result | json }}</pre>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Claude's Reasoning -->
      @if (reasoning) {
        <div class="reasoning-section">
          <h4>üß† Claude's Reasoning</h4>
          <div class="reasoning-text">{{ reasoning }}</div>
        </div>
      }

      <!-- Error -->
      @if (streamingError) {
        <div class="streaming-error">
          ‚ùå {{ streamingError }}
        </div>
      }
    </div>
  }

  <!-- Image Enlarged Modal -->
  @if (isImageEnlarged && imagePreview && !isPdf) {
    <div class="image-modal" (click)="toggleImageEnlarged()">
      <div class="modal-backdrop"></div>
      <div class="modal-content" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="toggleImageEnlarged(); $event.stopPropagation()">‚úï</button>
        <img [src]="imagePreview" alt="Receipt enlarged" class="enlarged-image" />
        <div class="modal-hint">Click anywhere to close</div>
      </div>
    </div>
  }

</div>
